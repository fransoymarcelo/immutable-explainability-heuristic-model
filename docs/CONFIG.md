# Configuration guide

This document summarises how the project is configured so you can reproduce experiments and extend the pipeline without digging through hard-coded constants.

## Precedence

Configuration is resolved in the following order:

1. `config/defaults.yaml` – versioned defaults.
2. `config/local.yaml` – optional, ignored by git; perfect for local overrides (paths, ports, toggles).
3. Environment variables – one-off overrides (see table below).
4. Runtime values – generated at runtime (for example the default `run_id`).

`config/loader.py` merges these layers and `config/settings.py` exposes an immutable `SETTINGS` object used throughout the codebase.

## `defaults.yaml` sections

| Section     | Description                                                                                   |
|-------------|-----------------------------------------------------------------------------------------------|
| `models`    | Whisper size selector, MFCC toggle, heuristic backend choice for text/audio.                  |
| `fusion`    | Fuzzy ruleset path and simple fusion thresholds (confidence, arousal).                        |
| `guardrails`| Probability/VAD thresholds, sensitive regexes, empathetic templates.                          |
| `paths`     | Audit directory, event filename, dynamic lexicon CSV, optional escalation webhook.            |
| `metrics`   | Prometheus `/metrics` port.                                                                   |
| `audio`     | Heuristic weights for the audio model (EMA alpha, base probabilities, per-format confidence). |
| `text`      | Dynamic lexicon parameters (min frequency/ratio) and neutral fallback.                        |
| `pii`       | PII redaction patterns (email, phone, etc.).                                                  |
| `runtime`   | Default prefix length for autogenerated `run_id`s.                                            |
| `blockchain`| Contract info path, environment variable names, gas limit, wait-for-receipt behaviour.        |

## Environment variables

| Variable                   | Effect                                                                    |
|----------------------------|---------------------------------------------------------------------------|
| `WHISPER_MODEL_SIZE`       | Overrides `models.whisper_size`.                                          |
| `USE_MFCC`                 | Enables/disables MFCC (`models.use_mfcc`). Accepts `true` / `false`.      |
| `TEXT_EMO_BACKEND`, `AUDIO_EMO_BACKEND` | Select alternative heuristic backends.                       |
| `FUZZY_RULESET`            | Overrides `fusion.fuzzy_ruleset`.                                         |
| `METRICS_PORT`             | Sets the Prometheus port.                                                 |
| `AUDIT_DIR`, `AUDIT_FILE`  | Override audit storage location.                                          |
| `TEXT_EMO_DYNAMIC_LEXICON` | Path to the CSV used for the dynamic lexicon.                             |
| `ESCALATION_WEBHOOK`       | Optional guardrails webhook URL.                                          |
| `RUN_ID`                   | Forces a specific run identifier.                                         |
| `RPC_URL`                  | RPC endpoint for the blockchain client (Sepolia by default).              |
| `PRIVATE_KEY`              | Private key used to sign anchor transactions (keep it secret locally).    |

`config/local.yaml` can mirror the defaults and tweak multiple values. Example:

```yaml
models:
  whisper_size: medium
  use_mfcc: true

fusion:
  fuzzy_ruleset: "config/rulesets/experimental.yaml"

paths:
  audit_dir: "/tmp/audit"
  dynamic_lexicon: "/home/user/datasets/mea/train.csv"

metrics:
  port: 9400
```

## Programmatic access

```python
from config.settings import SETTINGS

SETTINGS.models.whisper_size
SETTINGS.fusion.fusion_simple.text_confidence_thresh
SETTINGS.guardrails.templates.safe
SETTINGS.paths.dynamic_lexicon
```

Dumping the effective configuration:

```python
import json
from config.settings import SETTINGS

print(json.dumps(SETTINGS.to_dict(), indent=2))
```

## Best practices

- **Do not** hard-code thresholds or paths outside configuration modules; always read from `SETTINGS`.
- Track experiment-specific overrides in `config/local.yaml` (and mention them in notebooks/papers).
- When adding new parameters, update `defaults.yaml`, document them here, and extend `settings.py`.
- Never commit real credentials. Keep `.env` local; provide `.env.example` if needed.

## Suggested next steps

- Add smoke tests to validate critical settings (e.g. ensure `SETTINGS.fusion.fuzzy_ruleset` exists).
- Document which overrides were used for experiments so reviewers can reproduce results easily.

